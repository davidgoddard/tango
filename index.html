<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Author: David Goddard
  A tanda based music player for Tango DJs">
  <title>Tanda Player Lite</title>

  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">

  <!-- The following is a hack to allow FFmpeg to use concurrent threads off the main JS thread and share data between themselves -->
  <!-- <script src="./lib/enable_threads.js"></script>
 -->



  <!-- The following provides the underlying music player and file analyser -->
  <script src="./lib/howler.min.js"></script>
  <script src="./lib/ffmpeg.min.js"></script>

  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="./css/styles.css">

  <script type="module" src="./components/file.element.js"></script>
  <script type="module" src="./components/track.element.js"></script>
  <script type="module" src="./components/tanda.element.js"></script>
  <script type="module" src="./components/playlist.element.js"></script>
  <script type="module" src="./components/scratch-pad.element.js"></script>
  <script type="module" src="./components/search.element.js"></script>

  <!-- Searches -->
  <script type="module" src="./lib/search.js"></script>

  <!-- Manage core application start-up  -->
  <script type="module" src="./lib/main.js"></script>

</head>

<body>
  <header class="content">
    <button class="active" id="hamburger" aria-label="Open menu">⚙️</button>
    <h1>Tanda Player Lite</h1>
    <label>View: <select id="modeSelector"></select></label>
  </header>

  <div id="settingsPanel" class="side-panel content">
    <button class="active" id="closeBtn" aria-label="Close Settings">&times;</button>
    <h2>Settings</h2>
    <ul>
      <li>Links to classification page</li>
      <li>Define playlist timings: between tracks, after tanda, before tanda</li>
      <li>Reset column widths to defaults</li>
      <li>Edit preferred text items</li>
    </ul>

    <form>
      <legend>Defaults</legend>
      <label>Tanda Style Sequence: <input type="text" placeholder="E.g. 4T 4T 3W 4T 3M" value="4T 4T 3W 4T 3M" id="defaultTandaStyleSequence"></label>
    </form>

    <p>To use another folder as the source of music files requires clearing the old database which is stored in the
      browser. If you wish to save the current library of tandas etc. that goes with the current folder, then use the
      "Export" feature first.</p>
    <button class="active" id="exportDatabase">Export Database</button>
    <button class="active" id="rescanButton">Re-scan for new files only</button>
    <button class="active" id="rescanAnalyzeButton">Re-Analyze</button>
    <button class="active" id="deleteDBButton">Reset Database</button>
    <button class="active" id="loadLibraryButton">Open existing Tanda Player Library</button>

    <section id="scannerProgress">
      <h3>File Scanner Progress</h3>
      <p id="scanProgress"></p>
      <p id="scanFilePath"></p>
      <p id="scanFileName"></p>
    </section>
  </div>

  <main class="all">
    <div id="searchColumn" class="column content">

      <div class="tabs pre-defined-search-choice">
        <div class="tab-headers">
          <div class="tab-header active" data-tab="search-controls">Search</div>
          <div class="tab-header" data-tab="favourites-results">Favourites<span id="favourites-count"></span></div>
        </div>

        <div class="tab-contents">
          <div class="tab-content active" id="search-controls">
            <search-element id="generalSearch"></search-element>
          </div>
          <div class="tab-content" id="favourites-results">
            <search-element id="favouritesSearch"></search-element>
          </div>
        </div>
      </div>

      <ul>
        <li>Basic search</li>
        <li>Filter results by style and or other tags</li>
        <li>Via config, show standard lists: favourites, recently added, recently played</li>
        <li>Each item has click to move to clipboard</li>
      </ul>

    </div>
    <div class="handle" id="handle1"></div>
    <div id="scratchpadColumn" class="column content">
      <header class="playlistHeading">
        <h2>Scratch Pad</h2>
      </header>
      <ul>
        <li>New items added to top</li>
        <li>User can drag/drop and move items about</li>
        <li>Allow user to tag tandas or songs and allow grouping by them</li>
        <li>All tandas can be added to playlist: at current location, to end</li>
        <li>Content can be filtered by style or other tags</li>
      </ul>
      <scratch-pad-element id="scratchPad" playlistSelector="#playlist"></scratch-pad-element>
    </div>
    <div class="handle" id="handle2"></div>
    <div id="playlistColumn" class="column content">
      <section class="fixedColumnContent">
        <header class="playlistHeading">
          <h2>Playlist</h2>
          <section>
            <button id="stopButton"><img src="./icons/stopNow.png" alt="stop now"></button>
          </section>
          <section>
            <p>Show times:
              <label>Relative: <input type="radio" name="timingBase" value="relative">
                Real: <input type="radio" name="timingBase" value="realtime" checked="checked"></label>
            </p>
            <div class="playlist-settings-icon">⚙️</div>
          </section>
        </header>
        <div class="playlist-settings-panel">
          <header>
            <h1>Current Playlist Settings</h1>
            <button class="active playlist-settings-close-btn" aria-label="Close Playlist Settings">&times;</button>
          </header>
          <div class="playlist-settings-content">
            <form>
              <label class="field-container">Name: <input type="text" id="playlistName"></label>
              <label class="field-container">Cortina Set: <input type="text" id="cortinaSetName"></label>
              <label class="field-container">Tanda Style Sequence: <input type="text" id="tandaStyleSequence"
                  placeholder="E.g. 4T 4T 3W 4T 4T 3M"></label>
              <p>Time between tracks causes songs to overlap if a negative value is given and adds silence if positive.
                Note that songs are already trimmed of any leading and trailing silence.</p>
              <label class="field-container">Time between tracks: <input type="number" id="playlistTrackSpacing"
                  placeholder="Time in seconds between tracks"></label>
              <label class="field-container">Time before cortina: <input type="number" id="playlistPreCortina"
                  placeholder="Time in seconds before cortina (if used)"></label>
              <label class="field-container">Time after cortina: <input type="number" id="playlistPostCortina"
                  placeholder="Time in seconds after cortina (if used)"></label>
              <button id="savePlaylist">Save Playlist</button>
              <button id="loadPlaylist">Load Playlist</button>
                </form>
          </div>
        </div>
        <ul>
          <li>Filter by artist, song</li>
        </ul>
      </section>
      <playlist-element id="playlist" scratchpadSelector="#scratchPad">
      </playlist-element>
    </div>
  </main>


  <!-- <label>Tempo: <input id="tempo" type="range" min="0.8" max="1.3" step="0.01" value="0"><button id="tempoReset">Reset</button></label>
  <label>Volume: <input id="volume" type="range" min="0" max="100" step="0.1" value="100"></label> -->
  <div id="output"></div>

  <div id="permissionModal" class="overlay">
    <div class="modal">
      <h2>Permission Request</h2>
      <p>Tanda Player needs your permission to read your music files folder for all files. Please click 'Allow' to
        continue.</p>
      <button class="active" id="askUserPermission">Allow</button>
    </div>
  </div>


  <!-- handle hamberger menu and settings tabs -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {

      document.getElementById('hamburger').addEventListener('click', function () {
        document.getElementById('settingsPanel').style.transform = 'translateX(800px)';
      });

      document.getElementById('closeBtn').addEventListener('click', function () {
        document.getElementById('settingsPanel').style.transform = 'translateX(-800px)';
      });

      document.querySelector('.playlist-settings-icon').addEventListener('click', function () {
        const panel = document.querySelector('.playlist-settings-panel');
        panel.classList.toggle('active');
      })

      document.querySelector('.playlist-settings-close-btn').addEventListener('click', function () {
        const panel = document.querySelector('.playlist-settings-panel');
        panel.classList.toggle('active');
      })

    });

  </script>

  <!-- Handle user's choice of visible columns -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Set up handlers for column switching')
      const modeSelector = document.getElementById('modeSelector');
      const searchColumn = document.getElementById('searchColumn');
      const scratchpadColumn = document.getElementById('scratchpadColumn');
      const playlistColumn = document.getElementById('playlistColumn');
      const handle1 = document.getElementById('handle1');
      const handle2 = document.getElementById('handle2');

      // // Function to load widths from localStorage
      // function loadWidths(mode) {
      //   const widths = localStorage.getItem('widths_' + mode);
      //   if (widths) {
      //     const { col1Width, col3Width, col5Width } = JSON.parse(widths);
      //     col1.style.flexGrow = col1Width;
      //     col3.style.flexGrow = col3Width;
      //     col5.style.flexGrow = col5Width;
      //   }
      // }

      // // Function to save widths to localStorage
      // function saveWidths(mode) {
      //   const widths = {
      //     col1Width: col1.style.flexGrow,
      //     col3Width: col3.style.flexGrow,
      //     col5Width: col5.style.flexGrow
      //   };
      //   localStorage.setItem('widths_' + mode, JSON.stringify(widths));
      // }

      // Event listener for mode changes
      modeSelector.addEventListener('change', function () {
        const main = document.querySelector('main');
        const mode = modeSelector.value;

        console.log('Mode', mode)
        switch (mode) {
          case 'All columns':
            main.classList.remove('playlistOnly')
            main.classList.remove('searchOnly')
            main.classList.add('all')
            break;
          case 'Search':
            main.classList.remove('playlistOnly')
            main.classList.add('searchOnly')
            main.classList.remove('all')
            break;
          case 'Playlist':
            main.classList.add('playlistOnly')
            main.classList.remove('searchOnly')
            main.classList.remove('all')
            break;
        }
        // loadWidths(mode);
      });

      // // Initialize with default mode
      // modeSelector.value = 'all';
      // loadWidths('all');
    });
  </script>

  <!-- Handle column width adjustments -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {

      console.log('Setting up column width handlers')
      const container = document.querySelector('main');
      let startX, startWidthLeft, startWidthRight, handleBeingDragged;

      const dragStart = (e) => {
        handleBeingDragged = e.target;
        startX = e.clientX;
        const prevCol = handleBeingDragged.previousElementSibling;
        const nextCol = handleBeingDragged.nextElementSibling;
        startWidthLeft = prevCol.offsetWidth;
        startWidthRight = nextCol.offsetWidth;
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
      };

      const dragMove = (e) => {
        if (!handleBeingDragged) return;
        const dx = e.clientX - startX;
        const newLeftWidth = startWidthLeft + dx;
        const newRightWidth = startWidthRight - dx;
        const gridTemplateColumns = Array.from(container.children).map(child => {
          if (child === handleBeingDragged.previousElementSibling) {
            return `${newLeftWidth}px`;
          } else if (child === handleBeingDragged) {
            return '10px'; // handle width
          } else if (child === handleBeingDragged.nextElementSibling) {
            return `${newRightWidth}px`;
          } else {
            return `${child.style.flexGrow || '1fr'}`;
          }
        }).join(' ');
        container.style.gridTemplateColumns = gridTemplateColumns;
      };

      const dragEnd = () => {
        document.removeEventListener('mousemove', dragMove);
        document.removeEventListener('mouseup', dragEnd);
        handleBeingDragged = null;
      };

      const handles = document.querySelectorAll('.handle');
      handles.forEach(handle => handle.addEventListener('mousedown', dragStart));
    });

  </script>

  <!-- Handle language preferences -->
  <script>

    const configurableItems = [
      {
        type: 'select', selector: '#modeSelector',
        textValues: ['All columns', 'Search', 'Playlist'],
        preferredValues: ['All columns', 'Search', 'Playlist']
      },
      {
        type: 'select', selector: '.style-select',
        textValues: ['All styles', 'Tango', 'Waltz', 'Milonga'],
        preferredValues: ['All styles', 'Tango', 'Vals', 'Milonga']
      }
    ];

    const configuredItems = localStorage.getItem('Text Preferences') || configurableItems;

    /* Populate the page with user's preferred text */
    configuredItems.forEach((item) => {
      switch (item.type) {
        case 'select':
          const elements = document.querySelectorAll(item.selector)
          for (const e of elements) {
            e.innerHTML = item.textValues.map((value, idx) => {
              return `<option value="${value}">${item.preferredValues[idx]}</option>`
            }).join('')
          }
          break;
      }
    })

    console.log('Set up language support')

  </script>

  <!-- Handle settings -->
  <script type="module">
    import { DatabaseManager } from './lib/database.js';
    import { saveFileWithWritePermission } from './lib/file_system.js'

    document.addEventListener('DOMContentLoaded', async function () {
      const dbManager = await DatabaseManager();
      let libraryFileHandle = null;

      const exportButton = document.querySelector('#exportDatabase');
      exportButton.addEventListener('click', async () => {
        console.log('Exporting the database');
        const allData = await dbManager.exportAllData();
        console.log(allData)
        // const blob = new Blob([allData], { type: 'application/json' });
        // const url = URL.createObjectURL(blob);

        // // Create a link and trigger the download
        // const a = document.createElement('a');
        // a.href = url;
        // a.download = `tanda-player-library-backup.json`;
        // document.body.appendChild(a);
        // a.click();
        // document.body.removeChild(a);

        // // Revoke the blob URL after a delay
        // setTimeout(() => URL.revokeObjectURL(url), 100);

        libraryFileHandle = saveFileWithWritePermission(libraryFileHandle, allData);

      })
    });
  </script>
</body>

</html>